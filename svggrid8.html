<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>SVG</title>
    <!--
    <script type="text/javascript" src="fileSaver.js"></script>
    <script type="text/javascript" src="xmlToJson.js"></script>
    <script type="text/javascript" src="mouseController.js"></script>
    <script type="text/javascript" src="toolboxController.js"></script>
    <script type="text/javascript" src="anchorController.js"></script>
    <script type="text/javascript" src="svgObject.js"></script>
    <script type="text/javascript" src="svgElement.js"></script>
    <script type="text/javascript" src="point.js"></script>
    <script type="text/javascript" src="svgToolboxElement.js"></script>
    -->

    <script type="text/javascript" src="helpers.js"></script>

    <script type="text/javascript" src="models/model.js"></script>
    <script type="text/javascript" src="models/objectsModel.js"></script>
    <script type="text/javascript" src="models/shapeModel.js"></script>
    <script type="text/javascript" src="models/surfaceModel.js"></script>

    <script type="text/javascript" src="views/view.js"></script>
    <script type="text/javascript" src="views/objectsView.js"></script>
    <script type="text/javascript" src="views/surfaceView.js"></script>

    <script type="text/javascript" src="controllers/controller.js"></script>
    <script type="text/javascript" src="controllers/mouseController.js"></script>
    <script type="text/javascript" src="controllers/shapeController.js"></script>
    <script type="text/javascript" src="controllers/surfaceController.js"></script>

    <!--
    <script type="text/javascript" src="shapes/anchor.js"></script>
    <script type="text/javascript" src="shapes/surface.js"></script>
    <script type="text/javascript" src="shapes/toolboxSurface.js"></script>
    <script type="text/javascript" src="shapes/circle.js"></script>
    <script type="text/javascript" src="shapes/rectangle.js"></script>
    <script type="text/javascript" src="shapes/diamond.js"></script>
    <script type="text/javascript" src="shapes/line.js"></script>
    <script type="text/javascript" src="shapes/text.js"></script>
    <script type="text/javascript" src="shapes/toolboxRectangle.js"></script>
    <script type="text/javascript" src="shapes/toolboxCircle.js"></script>
    <script type="text/javascript" src="shapes/toolboxDiamond.js"></script>
    <script type="text/javascript" src="shapes/toolboxLine.js"></script>
    <script type="text/javascript" src="shapes/toolboxText.js"></script>
    -->
</head>
<body>
    <style>
        text {cursor:default}
    </style>
    <div>
        <!-- https://stackoverflow.com/questions/1944267/how-to-change-the-button-text-of-input-type-file -->
        <!-- creates a hidden file input on routes the button to clicking on that tag -->
        <button onclick="saveSvg()">Save</button>
        <button onclick="document.getElementById('fileInput').click();">Load</button>
        <input type="file" id="fileInput" style="display:none;"/>
        &nbsp; Text:
        <input id="text" type="text" onchange="setText()" />
    </div>
    <div>
        <svg id="svg" width="801" height="481" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <pattern id="smallGrid" width="8" height="8" patternUnits="userSpaceOnUse">
                    <path id="smallGridPath" d="M 8 0 H 0 V 8" fill="none" stroke="gray" stroke-width="0.5" />
                </pattern>
                <pattern id="largeGrid" width="80" height="80" patternUnits="userSpaceOnUse">
                    <rect id="largeGridRect" width="80" height="80" fill="url(#smallGrid)" />
                    <!-- draw from upper right to upper left, then down to lower left -->
                    <!-- This creates the appearance of an 80x80 grid when stacked -->
                    <path id="largeGridPath" d="M 80 0 H 0 V 80" fill="none" stroke="gray" stroke-width="2" />
                </pattern>
            </defs>

            <!-- A trick from sprite animations is to extend the scrolling region beyond the viewport
                and use mod W/H to reset the position to simulate a virtual space. -->
            <!-- Creating a group is structural only.  One would think that elements could
                be added to the group and they would be moved as the group is transformed.
                This is true, but when the mod operator resets the translation to (0, 0), any elements
                in this group will be reset to it's starting position as well. -->
            <g id="surface" transform="translate(0, 0)" x="-80" y="-80" width="961" height="641">
                <rect id="grid" x="-80" y="-80" width="961" height="641" fill="url(#largeGrid)" />
            </g>
            <!-- Instead, create a group just for the objects and transform this group without any
                modulus operation on the (x,y) position. -->
            <!-- Also, we create an outer group so that on file load, we can remove
                the "objectGroup" and replace it with what got loaded. -->
            <g id="objectGroup">
                <g id="objects" transform="translate(0, 0)"></g>
            </g>
            <g id="anchors"></g>
            <!-- toolbox goes here -->
        </svg>
    </div>
</body>
</html>
<script type="text/javascript">
    const SVG_ELEMENT_ID = "svg";
    const SVG_SURFACE_ID = "surface";
    const SVG_TOOLBOX_SURFACE_ID = "toolboxSurface";
    const SVG_OBJECTS_ID = "objects";
    const SVG_TOOLBOX_ID = "toolbox";
    const SHAPE_CLASS_NAME = "svgShape";
    const FILE_INPUT = "fileInput";
    const OBJECT_GROUP_ID = "objectGroup";
    const FILENAME = "data.svg";
    const TOOLBOX_RECTANGLE_ID = "toolboxRectangle";
    const TOOLBOX_CIRCLE_ID = "toolboxCircle";
    const TOOLBOX_DIAMOND_ID = "toolboxDiamond";
    const TOOLBOX_LINE_ID = "toolboxLine";
    const TOOLBOX_TEXT_ID = "toolboxText";
    const ANCHORS_ID = "anchors";
    const START_OF_DIAGRAM_TAG = "<diagram>";
    const END_OF_DIAGRAM_TAG = "</diagram>";

    // Must be lowercase "shapename" - "shapeName", as set in the toolbox controller, the DOM adds elements as lowercase!
    // https://stackoverflow.com/a/6386486/2276361
    const SHAPE_NAME_ATTR = "shapename";

    (function initialize() {
        var mouseController = new MouseController();
        var svgSurface = Helpers.getElement(SVG_SURFACE_ID);
        var svgObjects = Helpers.getElement(SVG_OBJECTS_ID);
        var surfaceModel = new SurfaceModel();
        var objectsModel = new ObjectsModel();
        var surfaceView = new SurfaceView(svgSurface, surfaceModel);
        var objectsView = new ObjectsView(svgObjects, objectsModel);

        var surfaceController = new SurfaceController(mouseController, surfaceView, surfaceModel);

        mouseController.attach(surfaceView, surfaceController);
        surfaceModel.resizeGrid(100, 100, 20, 20);

        // mouseController.setSurface(surface);

        // var toolboxController = new ToolboxController(mouseController);

        // So we can handle mouse drag operations when the mouse moves onto the toolbox surface...
        // var toolboxSurface = new ToolboxSurface(toolboxController, svgToolboxSurface);

        // The surface mouse controller needs to know the toolbox controller to finish
        // a toolbox drag & drop operation.
        // mouseController.setToolboxController(toolboxController);
        // To compensate for translations when doing a toolbox drag&drop
        // mouseController.setSurfaceShape(surface);
        // toolboxController.setSurfaceShape(surface);

        //new ToolboxRectangle(toolboxController, getElement(TOOLBOX_RECTANGLE_ID));
        //new ToolboxCircle(toolboxController, getElement(TOOLBOX_CIRCLE_ID));
        //new ToolboxDiamond(toolboxController, getElement(TOOLBOX_DIAMOND_ID));
        //new ToolboxLine(toolboxController, getElement(TOOLBOX_LINE_ID));
        //new ToolboxText(toolboxController, getElement(TOOLBOX_TEXT_ID));
    })();

</script>
<!--
    mousedown example:
    https://stackoverflow.com/questions/2753732/how-to-access-svg-elements-with-javascript

    why preventDefault()
    https://stackoverflow.com/questions/12624745/svg-mousemove-events-stop-firing-in-firefox-after-a-few-mousedowns

    transform -> translate
    https://stackoverflow.com/questions/13281586/svg-animate-rectangle-along-path-center-of-rect-always-on-the-path

    SVG Paths:
    https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths

    Transforms:
    https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/transform

    Working with defs programmatically:
    https://stackoverflow.com/questions/17776641/fill-rect-with-pattern

    // The same thing:
    <path d="M 8 0 L 0 0 0 8" />
    <path d="M 8 0 H 0 V 8" />

    Event listeners inside a class:
    https://stackoverflow.com/questions/43727516/javascript-how-adding-event-handler-inside-a-class-with-a-class-method-as-the-c
    https://stackoverflow.com/questions/20279484/how-to-access-the-correct-this-inside-a-callback

    // Lightweight library for manipulating svg:
    http://svgjs.com/ 

    // Download doesn't work in edge
    // See StephenKitely's response.
    // This is insane, and registry paths aren't there on W10
    // https://answers.microsoft.com/en-us/ie/forum/ie11-iewindows_10/microsoft-edge-wont-download-any-files/82fafcf9-4264-4593-bc7b-33bd569a276f
    // And more insanity
    // https://www.tenforums.com/browsers-email/57077-edge-wont-save-anything-i-broke.html

    // Saving files locally, but doesn't work in Edge:
    https://stackoverflow.com/questions/21012580/is-it-possible-to-write-data-to-file-using-only-javascript


-->
